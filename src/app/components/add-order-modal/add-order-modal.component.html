<div class="modal fade show" 
     [class.d-block]="show" 
     tabindex="-1" 
     role="dialog"
     (click)="onBackdropClick($event)">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-cart-plus me-2"></i>
          Add New Order
        </h5>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col">
            <p class="text-muted mb-0">
              Add order items by entering barcode, quantity, and MRP for each item.
            </p>
          </div>
        </div>

        <!-- Order Items Table -->
        <div class="table-responsive">
          <table class="table table-borderless">
            <thead class="table-light">
              <tr>
                <th scope="col" class="col-5">Barcode</th>
                <th scope="col" class="col-2">Quantity</th>
                <th scope="col" class="col-3">MRP (â‚¹)</th>
                <th scope="col" class="col-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of orderItems; let i = index" class="align-middle">
                <!-- Barcode Field -->
                <td>
                  <div class="input-group">
                    <input 
                      type="text" 
                      class="form-control form-control-sm" 
                      [class.is-invalid]="hasFieldError('barcode', i) || isBarcodeInvalid(i)"
                      [class.is-valid]="isBarcodeValid(i)"
                      [(ngModel)]="item.barcode"
                      placeholder="Enter barcode"
                      maxlength="50"
                      (blur)="onBarcodeBlur(i)"
                      (input)="onBarcodeInput(i)"
                      (keyup.enter)="onSubmit()"
                      (keyup.escape)="closeModal()">
                    
                    <span class="input-group-text" *ngIf="isBarcodeChecking(i)">
                      <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Validating...</span>
                      </div>
                    </span>
                    
                    <span class="input-group-text text-success" *ngIf="isBarcodeValid(i)">
                      <i class="bi bi-check-circle"></i>
                    </span>
                    
                    <span class="input-group-text text-danger" *ngIf="isBarcodeInvalid(i)">
                      <i class="bi bi-x-circle" 
                         style="cursor: pointer;" 
                         (click)="clearBarcodeField(i)"
                         title="Clear barcode field"></i>
                    </span>
                  </div>
                  
                  <div class="invalid-feedback" *ngIf="hasFieldError('barcode', i)">
                    {{ getFieldError('barcode', i) }}
                  </div>
                </td>

                <!-- Quantity Field -->
                <td>
                  <input 
                    type="text" 
                    class="form-control form-control-sm" 
                    [class.is-invalid]="hasFieldError('quantity', i)"
                    [(ngModel)]="item.quantity"
                    placeholder="Qty"
                    (input)="validateField('quantity', i)"
                    (keydown)="onQuantityKeyDown($event)"
                    (keyup.enter)="onSubmit()"
                    (keyup.escape)="closeModal()">
                  
                  <div class="invalid-feedback" *ngIf="hasFieldError('quantity', i)">
                    {{ getFieldError('quantity', i) }}
                  </div>
                </td>

                <!-- MRP Field -->
                <td>
                  <input 
                    type="text" 
                    class="form-control form-control-sm" 
                    [class.is-invalid]="hasFieldError('mrp', i)"
                    [(ngModel)]="item.mrp"
                    placeholder="MRP"
                    (input)="validateField('mrp', i)"
                    (keydown)="onNumberKeyDown($event)"
                    (keyup.enter)="onSubmit()"
                    (keyup.escape)="closeModal()">
                  
                  <div class="invalid-feedback" *ngIf="hasFieldError('mrp', i)">
                    {{ getFieldError('mrp', i) }}
                  </div>
                </td>

                <!-- Actions -->
                <td class="text-center">
                  <button 
                    type="button" 
                    class="btn btn-outline-danger btn-sm"
                    (click)="removeOrderItem(i)"
                    [disabled]="orderItems.length === 1"
                    title="Remove item">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Add Row Button -->
        <div class="row mt-3">
          <div class="col">
            <button 
              type="button" 
              class="btn btn-outline-primary btn-sm"
              (click)="addOrderItem()"
              title="Add another item">
              <i class="bi bi-plus-circle me-1"></i>
              Add Another Item
            </button>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" 
                class="btn btn-outline-danger btn-sm" 
                (click)="closeModal()">
          Cancel
        </button>
        <button type="button" 
                class="btn btn-primary btn-sm" 
                (click)="onSubmit()"
                [disabled]="!isFormValid()">
          <i class="bi bi-check-circle me-1"></i>
          Create Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="show"></div> 